(function(f){var g=function(a,b){this.key=a;this.value=b},k=function(a){this.key=a;this.name="UnacceptableKeyException";this.message="The specified key is invalid: ["+a+"]"},m=function(){this.name="InvalidTrackingDataException";this.message="The configuration is invalid and the timings could not be sent."},l={initialize:function(){this.extend(this.options,this.defaults,this.getAttributeOptions());this.attach()},defaults:{host:"https://metrics.smartertravel.net",timingEndPoint:"trackTimings.gif",trackPerformanceOnLoad:!1, siteName:null,pageName:null,env:"dev",version:1,logging:!1},fallbackStartTime:(new Date).getTime(),hasSentPerformanceTimings:!1,marks:{},options:{},getFallbackStartTime:function(){return this.fallbackStartTime},getOption:function(a){return this.options.hasOwnProperty(a)?this.options[a]:null},setOption:function(a,b){this.options[a]=b;return this},removeMark:function(a){a=this.sanitizeKey(a);this.marks.hasOwnProperty(a)&&delete this.marks[a];return this},sanitizeKey:function(a){null===a||1>a.length? a="":(a=a.replace(/[^A-Z0-9_-]+/ig,""),a=a.toLowerCase());return a},setMark:function(a){var b=this.sanitizeKey(a);if(!b.length)throw new k(a);this.marks[b]=this.getCurrentTime();return this},trackMark:function(a){var b=this.sanitizeKey(a),d;this.marks.hasOwnProperty(b)&&(d=this.marks[b],d=this.getCurrentTime()-d,a=new g(a,d),this.trackTimings([a]),delete this.marks[b]);return this},onLoad:function(){this.options.trackPerformanceOnLoad&&this.trackPerformanceTimings()},addTiming:function(a,b,d){var c= this.sanitizeKey(a.key),e;if(0<c.length)b[d+"."+c]=a.value;else throw new k(e);return this},attach:function(){var a=this;f.onload=function(){a.onLoad()};return this},buildUrl:function(a,b){var d=[],c;for(c in b)b.hasOwnProperty(c)&&d.push(encodeURIComponent(c)+"="+encodeURIComponent(b[c]));return a+"?"+d.join("&")},extend:function(a,b){for(var d=Array.prototype.slice.call(arguments,1),c,e=0;e<d.length;e++)if(c=d[e])for(var h in c)a[h]=c[h];return a},getAttributeByName:function(a,b){return a&&"object"=== typeof a&&a.hasAttribute(b)?a.getAttribute(b):null},getAttributeOptions:function(){var a=this.getScriptTag();if(!a)return{};var b={},d=this.getAttributeByName(a,"data-metrics-host"),c=this.getAttributeByName(a,"data-metrics-track-performance-on-load"),e=this.getAttributeByName(a,"data-metrics-site-name"),h=this.getAttributeByName(a,"data-metrics-env"),f=this.getAttributeByName(a,"data-metrics-page-name"),g=this.getAttributeByName(a,"data-metrics-version"),a=this.getAttributeByName(a,"data-metrics-logging"); null!==d&&(b.host=d);null!==c&&(b.trackPerformanceOnLoad=!0===c||"true"===c);null!==e&&(b.siteName=e);null!==f&&(b.pageName=f);null!==h&&(b.env=h);null===g||isNaN(g)||(b.version=Number(g));null!==a&&(b.logging=!0===a||"true"===a);return b},getCurrentTime:function(){return(new Date).getTime()},getKey:function(a,b,d){var c=[];a&&a.length&&c.push(a);d&&d.length&&c.push(d);b&&b.length&&(c.push("pages"),c.push(b));return c.join(".")},getScriptTag:function(){for(var a=f.document.getElementsByTagName("script"), b=null,d,c=0;c<a.length;c++)if((d=a[c])&&d.hasAttribute("data-metrics")){b=d;break}return b},getTimings:function(){var a=this.getTimingsModern();1>a.length&&(a=this.getTimingsFallback());return a},getTimingsFallback:function(){var a=[],b=new g("fallbackLoadEventEnd",this.getCurrentTime()-this.getFallbackStartTime());a.push(b);return a},getTimingsModern:function(){var a=[],b,d,c;if(f.performance){b=f.performance.timing;d=b.navigationStart;for(var e in b)c=b[e],"number"===typeof c&&0<c&&a.push(new g(e, c-d))}return a},isValidTrackingData:function(a,b){var d=!0;if(!a||1>a.length)d=!1;else if(!b||1>b.length)d=!1;return d},logError:function(a){var b=f.console||{};!0===this.options.logging&&"function"===typeof b.log&&b.log(a);return this},trackPerformanceTimings:function(){if(!this.hasSentPerformanceTimings)try{this.trackTimings(this.getTimings()),this.hasSentPerformanceTimings=!0}catch(a){this.logError(a.message)}return this},trackTimings:function(a){var b=this.sanitizeKey(this.options.env),d=this.options.host+ "/"+this.options.timingEndPoint,c=this.sanitizeKey(this.options.pageName),e=this.sanitizeKey(this.options.siteName),f;if(this.isValidTrackingData(e,c)){f=new Image;b=this.getKey(e,c,b);c={v:this.options.version,c:this.getCurrentTime()};for(e=0;e<a.length;e++)try{this.addTiming(a[e],c,b)}catch(g){this.logError(g.message)}f.src=this.buildUrl(d,c)}else throw new m;return this}};f.Metrics=l;f.MetricsTiming=g;l.initialize()})(window);
